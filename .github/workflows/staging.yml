name: staging

on:
  push:
    branches:
      - release/*
      - hotfix/*

jobs:
  start-local-server:
    runs-on: self-hosted
    steps:
      - name: Start local server
        run: ./start_local_server.sh
      - name: Wait for server to start
        run: sleep 10s

  run-tests:
    needs: start-local-server
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Cypress install
        uses: cypress-io/github-action@v5
        with:
          runTests: false

      - name: Wait for Cypress install
        run: sleep 10s

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Typescript check
        run: yarn types

      - name: Lint check
        run: yarn lint

      - name: Run Chrome Web Tests
        uses: cypress-io/github-action@v5.5.1
        with:
          start: "npm run start:ci"
          record: true
          wait-on: "http://localhost:8888"
          wait-on-timeout: 120
          browser: chrome
          group: "UI - Web Tests Chrome"
          spec: cypress/e2e/*
          config-file: cypress.config.ts
          config: baseUrl=http://localhost:8888
        env:
          CYPRESS_PROJECT_ID: ${{ secrets.CYPRESS_PROJECT_ID }}
          CYPRESS_RECORD_KEY: ${{secrets.CYPRESS_RECORD_KEY}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
          DEBUG: "cypress:server:args"

      - name: Run Chrome Mobile Tests
        uses: cypress-io/github-action@v5.5.1
        with:
          config: "viewportWidth=375,viewportHeight=667"
          start: "npm run start:ci"
          record: true
          wait-on: "http://localhost:8888"
          wait-on-timeout: 120
          browser: chrome
          group: "UI - Mobile Tests Chrome"
          spec: cypress/e2e/*
          config-file: cypress.config.ts
        env:
          CYPRESS_PROJECT_ID: ${{ secrets.CYPRESS_PROJECT_ID }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEBUG: "cypress:server:args"
